<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cloud Notepad</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root {
      --bg: #09090b;
      --panel: #121214;
      --border: rgba(255, 255, 255, 0.08);
      --input-bg: rgba(255, 255, 255, 0.03);
      --muted: #71717a;
      --text: #fafafa;
      --accent: #cf780e; 
      --success: #10b981;
      --error: #ef4444;
      --radius: 8px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background-color: var(--bg); color: var(--text); }
    body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; display: flex; justify-content: center; padding: 40px 24px; }

    .wrap { width: 100%; max-width: 1200px; position: relative; }

    header { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; }
    .logo { width: 42px; height: 42px; border-radius: 50%; display: grid; place-items: center; font-weight: 500; color: var(--accent); border: 1px solid var(--accent); }
    h1 { margin: 0; font-size: 20px; font-weight: 500; }
    .subtitle { color: var(--muted); font-size: 13px; }

    .grid-main { display: grid; grid-template-columns: 320px 1fr; gap: 30px; align-items: start; }

    .side-card, .editor-container { background: var(--panel); border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; }
    .side-card { padding: 20px; max-height: 85vh; overflow-y: auto; }

    .field { margin-bottom: 16px; }
    label { display: block; font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); font-weight: 600; margin-bottom: 6px; }

    input, textarea { width: 100%; padding: 10px; background: var(--input-bg); border-radius: 6px; color: var(--text); border: 1px solid var(--border); outline: none; font-size: 13px; }
    input:focus { border-color: var(--accent); }

    /* Image Gallery UX */
    .image-section { margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border); }
    .image-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 12px; }
    .img-card { position: relative; border-radius: 4px; overflow: hidden; border: 1px solid var(--border); background: #000; aspect-ratio: 1; cursor: pointer; }
    .img-card img { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; transition: 0.2s; }
    .img-card:hover img { opacity: 1; }
    .img-card .img-name { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.7); font-size: 9px; padding: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Workspace / Editor UX */
    .editor-header { display: flex; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.02); }
    .tab-btn { padding: 12px 20px; font-size: 12px; font-weight: 500; color: var(--muted); cursor: pointer; border: none; background: none; border-right: 1px solid var(--border); }
    .tab-btn.active { color: var(--accent); background: var(--input-bg); }

    #editor, #preview { height: 600px; padding: 25px; line-height: 1.6; }
    #preview { overflow-y: auto; display: none; background: var(--bg); }
    #preview img { max-width: 100%; border-radius: 4px; }
    textarea#editor { font-family: 'SFMono-Regular', monospace; resize: none; border: none; }

    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; border: none; transition: 0.2s; }
    .btn-primary { background: var(--accent); color: white; width: 100%; }
    .btn-ghost { background: transparent; color: var(--muted); border: 1px solid var(--border); }
    .btn-ghost:hover { border-color: var(--muted); color: var(--text); }

    .status { font-size: 11px; color: var(--muted); margin-top: 15px; display: flex; align-items: center; gap: 8px; }
    .spinner { width: 12px; height: 12px; border: 2px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }

  </style>
</head>
<body>

<div class="wrap">
  <header>
    <div class="logo">CN</div>
    <div>
      <h1>Cloud Notepad</h1>
      <div class="subtitle">Press <kbd>Ctrl+S</kbd> to save notes</div>
    </div>
  </header>

  <main class="grid-main">
    <aside class="side-card">
      <div class="field">
        <label>GitHub Token</label>
        <input id="token" type="password" value="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" />
      </div>

      <div class="field">
        <label>Repository</label>
        <input id="repo" value="Hanseooo/cloud-notepad" />
      </div>

      <div style="display:flex; gap:10px">
        <div class="field">
          <label>Branch</label>
          <input id="branch" value="main" />
        </div>
        <div class="field">
          <label>Folder</label>
          <input id="folder" value="notes" />
        </div>
      </div>

      <div class="field">
        <label>Filename</label>
        <input id="filename" value="notes.txt" />
      </div>

      <div style="display:flex; flex-direction: column; gap:10px;">
        <button id="loadBtn" class="btn btn-ghost" onclick="loadFile()">Load Notes</button>
        <button id="saveBtn" class="btn btn-primary" onclick="saveFile()">Save Changes</button>
        
        <div class="image-section">
          <label>Image Assets</label>
          <div style="display:flex; gap:5px; margin-bottom:10px">
            <button class="btn btn-ghost btn-sm" style="flex:1; padding:5px;" onclick="document.getElementById('imgInput').click()">Upload</button>
            <button class="btn btn-ghost btn-sm" style="flex:1; padding:5px;" onclick="refreshImages()">Refresh</button>
          </div>
          <input type="file" id="imgInput" style="display:none" accept="image/*" onchange="uploadImage(this)" />
          <div id="imageGrid" class="image-grid"></div>
        </div>

        <div id="status" class="status">
          <div class="spinner" id="spinner"></div>
          <span id="statusMsg">Ready</span>
        </div>
      </div>
    </aside>

    <div class="editor-container">
      <div class="editor-header">
        <button class="tab-btn active" id="writeTab" onclick="switchTab('write')">Write</button>
        <button class="tab-btn" id="previewTab" onclick="switchTab('preview')">Preview</button>
      </div>
      <textarea id="editor" placeholder="Write your markdown here..."></textarea>
      <div id="preview" class="markdown-body"></div>
    </div>
  </main>
</div>

<script>
  const editor = document.getElementById('editor');
  const preview = document.getElementById('preview');
  const statusMsg = document.getElementById('statusMsg');
  const spinner = document.getElementById('spinner');

  // Keyboard Shortcuts
  window.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
      e.preventDefault();
      saveFile();
    }
  });

  function setStatus(msg, type = '') {
    statusMsg.textContent = msg;
    statusMsg.style.color = type === 'error' ? 'var(--error)' : (type === 'success' ? 'var(--success)' : 'var(--muted)');
  }

  function setLoading(active) {
    spinner.style.display = active ? 'block' : 'none';
  }

  function cfg() {
    return {
      token: document.getElementById('token').value.trim(),
      repo: document.getElementById('repo').value.trim(),
      branch: document.getElementById('branch').value.trim(),
      folder: document.getElementById('folder').value.trim(),
      file: document.getElementById('filename').value.trim(),
      text: editor.value
    };
  }

  function switchTab(mode) {
    const isWrite = mode === 'write';
    document.getElementById('writeTab').classList.toggle('active', isWrite);
    document.getElementById('previewTab').classList.toggle('active', !isWrite);
    editor.style.display = isWrite ? 'block' : 'none';
    preview.style.display = isWrite ? 'none' : 'block';
    if (!isWrite) preview.innerHTML = marked.parse(editor.value);
  }

  async function loadFile() {
    const { token, repo, branch, folder, file } = cfg();
    const path = folder ? `${folder}/${file}` : file;
    setLoading(true);
    try {
      const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) throw new Error('Note not found');
      const j = await res.json();
      editor.value = atob(j.content);
      setStatus('Notes loaded', 'success');
      refreshImages(); // Auto-refresh images when loading repo
    } catch (e) { setStatus(e.message, 'error'); }
    finally { setLoading(false); }
  }

  async function saveFile() {
    const { token, repo, branch, folder, file, text } = cfg();
    const path = folder ? `${folder}/${file}` : file;
    setLoading(true);
    try {
      let sha;
      const check = await fetch(`https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (check.ok) sha = (await check.json()).sha;

      const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
        method: 'PUT',
        headers: { Authorization: `Bearer ${token}` },
        body: JSON.stringify({ message: 'Sync notes', content: btoa(text), branch, sha })
      });
      if (!res.ok) throw new Error('Sync failed');
      setStatus('Changes saved', 'success');
    } catch (e) { setStatus(e.message, 'error'); }
    finally { setLoading(false); }
  }

  async function refreshImages() {
    const { token, repo, branch, folder } = cfg();
    try {
      const res = await fetch(`https://api.github.com/repos/${repo}/contents/${folder}?ref=${branch}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const files = await res.json();
      const imgs = files.filter(f => /\.(jpg|jpeg|png|gif|webp)$/i.test(f.name));
      
      const grid = document.getElementById('imageGrid');
      grid.innerHTML = '';
      imgs.forEach(img => {
        const card = document.createElement('div');
        card.className = 'img-card';
        card.onclick = () => {
          navigator.clipboard.writeText(`![${img.name}](${img.path})`);
          setStatus('Markdown link copied!');
        };
        card.innerHTML = `<img src="${img.download_url}"><div class="img-name">${img.name}</div>`;
        grid.appendChild(card);
      });
    } catch (e) { console.error('Gallery sync failed'); }
  }

  async function uploadImage(input) {
    if (!input.files[0]) return;
    const file = input.files[0];
    const { token, repo, branch, folder } = cfg();
    const path = folder ? `${folder}/${file.name}` : file.name;

    setLoading(true);
    const reader = new FileReader();
    reader.onload = async (e) => {
      const content = e.target.result.split(',')[1];
      try {
        let sha;
        const check = await fetch(`https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (check.ok) sha = (await check.json()).sha;

        await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
          method: 'PUT',
          headers: { Authorization: `Bearer ${token}` },
          body: JSON.stringify({ message: `Upload ${file.name}`, content, branch, sha })
        });
        setStatus('Image uploaded', 'success');
        refreshImages();
      } catch (err) { setStatus('Upload failed', 'error'); }
      finally { setLoading(false); }
    };
    reader.readAsDataURL(file);
  }
</script>
</body>
</html>
